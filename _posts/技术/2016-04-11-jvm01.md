---
layout: post
title: java内存区域划分
category: 技术
tags: JVM
keywords: JVM heap stack 
description: 
---

　　Java的内存交由JVM管理，这为我们开发过程剩了不少事，但并不意味着我们就可以完全不用去关心JVM是怎么管理内存的。一方面，一旦内存出现泄漏，如果不了解jvm是怎么使用内存的，排查错误将是一件非常难的事情，另一方面，知道jvm是怎么使用内存的，可以帮助我们解答很多的疑问。记得刚开始关注java内存的时候，听得最多的就是堆内存、栈内存、常量池等等，这一系列问题困扰了我很长时间，而且这些问题是不可跳过的。

　　一个问题从疑惑到真正的理解，只有经历了这个过程，再去给别人讲的时候你才有可能知道，他最困惑的是哪里，这里我会从我自身的角度尽可能的去阐述关于java内存的这些问题，如果有人能从中受益，那我也算没白忙活了。

###jvm内存区域划分

　　java的内存全权交由jvm管理,那jvm是怎么管理内存的呢？jvm到底划分了多少内存区域？是不是就像道听途说的那样有堆内存和栈内存呢？堆内存和栈内存有什么区别呢。。。

　　上面这些问题，我都遇到过，不要急，先来看一张图，这张图就是jvm运行时划分的所有内存区域，后面我们会对这些每一个区域进行讲解。

　　![16041101](/public/img/tec/2016-4-1-jvm01.png)

####1. 程序计数器

　　程序计数器只占很小的一部分内存，可以通俗的理解为当前线程所执行的字节码的行号指示器（这里只是为了理解的做的一个比喻），字节码解释器通过改变这个计数器的值来选取下一行要执行的字节码命令。

　　由于jvm的多线程是通过不断的切换执行权限的方式实现的，同一时刻一个处理器只会执行一条线程中的命令，所以为了保证线程切换后能恢复到正确的执行位置，**每个线程都需要一个独立的程序计数器**，所以这块区域是线程私有的，不同的线程间相互独立，互不影响。

####2. java虚拟机栈

　　**java虚拟机栈也是线程私有的**，他的生命周期与线程相同。java虚拟机栈描述的是java方法执行时的内存模型：每个方法执行时都会在栈中创建一个栈帧，用于存储局部变量表、操作数栈、方法出口等等。每一个方法从调用到执行完成，就对应一个栈帧在虚拟机栈中从入栈到出栈的过程。

　　局部变量表中存放了编译期可知的各种基本类型、引用类型和returnAddress类型（指向了一条字节码指令地址）。

　　所谓的“栈内存”，指的就是虚拟机栈，或者虚拟机栈中的局部变量表。

####3. 本地方法栈

　　本地方法栈与虚拟机栈的唯一区别就是：虚拟机栈对虚拟机执行java方法服务，而本地方法栈为虚拟机执行Native方法服务。

　　有的虚拟机直接把虚拟机栈和本地方法栈合在一起（比如Sun HotSpot虚拟机）　　　

####4. java堆

　　对于绝大多数应用程序来说，堆内存是java虚拟机管理的最大一块内存，这块内存被所有的线程共享（被所有线程共享的内存有两块：方法区和堆内存，方法区下面会讲），在虚拟机启动的时候创建，此内存区域的唯一目的就是存放对象实例。

　　这块内存区域也是垃圾回收管理的主要区域。

####5. 方法区

　　与java堆内存一样，这是一块被所有线程共享的内存，用于存放虚拟机加载的类信息、常量、静态变量、即时编译器编译后的代码等数据。

　　运行时常量池，就是所谓的“常量池”，常量池也是方法区的一部分。Class类文件除了有类的版本、字段、方法、接口等描述信息外，还有一项信息就是常量池，用于存放编译器生成的各种字面量和符号引用，这部分内容在类加载后，进入方法区的运行时常量池中存放。

总结：上面就是jvm运行时对内存的一个大致的划分，不同的jvm虚拟机的实现方式可能有所不同，但本文的目的只是为了对jvm内存划分有一个初步的认识，想更深的了解jvm内存区域划分和管理推荐阅读《java虚拟机规范》、《深入理解java虚拟机》，本文的内容也是根据书中内容整理。

　　　　　　